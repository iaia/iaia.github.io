バッチ実装

- 必ずこのバッチは何のバッチなのか説明するコメントを先頭にいれること
    - バッチはいつも難しい処理をしている
    - 簡単に実行できない
    - 実行して良いのかも分からない
    - どういう振る舞いをしているか想像が出来ない
    - 途中で止めても良いのかも分からない
    - どういう結果が出るのか分からない
    - どういう結果が出ていればいいのか分からない
    - 実装を見ない限り、名前から推測するしか無い
    - コメントには以下を書くこと
        - どういうバッチか
            - 何を目的としているか
        - 実行頻度はどの程度を期待しているか
            - 1日に1回? 1時間毎?
        - どういうことをしているか
            - どこのデータを拾って
            - どういう計算をしているか
            - どこに結果をおいているか
        - 引数はどういうものがあるか
            - DRY RUNできるか?
- 引数を受け取るようにすること
    - 後述のdry runのため
    - パラメータだけをいじって処理を高速化させたいなど
- dry runできるようにすること
    - バッチは破壊的な処理がよく行われる
    - 開発環境でOKでも、本番ではどういうデータが処理されるか確認したい
    - 次に変更するとき試しに実行したいときのため
- ログor標準出力吐くようにすること
    - バッチを実行している間何も出てこないと不安になる
        - 何かに時間がかかっているのか、止まってしまっているのか
    - 本番でエラーを吐いたが、どのデータが原因でエラーが出たのか分からない
    - 何件処理しようとしているのか
        - 事前の調査で100件処理されるはずなのに10件しか処理されていなかった
- テストを結果対象を全て確認すること
    - バッチの結果、なにかデータをDBにいれるのか、ファイルを置くのか
    - データをDBに入れるなら入れた先のテーブル全てを確認すること
    - ファイルがあるならそれの存在確認、その中身も確認すること
- ただ一つの目的のためにただ一つのバッチを作ること
    - 複数の目的を一つのバッチ内で行ってはならない
- いつだってバッチは問題が起きることを想定すること
    - 夜中に動いていたらエラーでアラートがあがった
    - 1時間で終わるはずなのに10時間もかかっていた
    - 実装したあなた以外がいつもこの対処を行う
    - あなた以外がストレスなく、とりあえずの対処を行えるようにしておこう
        - コメントなど
- ずっと動き続けることに気をつけること
    - あなたが会社をやめてもこのバッチは動き続ける
    - 止めても良いのか、消しても良いのか判断できるようにしておこう
- 時間のかかる処理だとしても最大どの程度くらいか想定すること
    - 必ずクエリの中身を見ること
        - N+1になっていれば必ず早晩実行時間で問題になる
    - 高速化できるのであれば高速化すること
- あっちこっち見なくとも良いようにすること
    - このバッチの全体感が1ファイルで見通せるようにすること
    - 全てを別ファイルに委譲しないこと
        - 例えば継承していてスーパークラスに全てのメソッドがあるなど
- どういう手順を踏んでいるか分かるようにすること
    - 単純であればエントリポイントに直に書いても良い
    - そうでないなら責務ごとに適切に分割すること
        - バッチではおおよそ以下のようになるはず
        - データを取得 => 何らかの計算 => 出力(例1)
        - 複数箇所からデータ取得がある、あるいは複数箇所に出力する場合(例2)
        - ファサードの中はネストしたファサードになってはならない(例3)
例1
```ruby
def run
  data = fetch_data
  result = calculate(data)
  save(data)
end
```

例2
```ruby
def run
  data = fetch_from_db
  csv_body = read_csv
  result = calculate(data, csv_body)
  save_to_db(result)
  output_to_csv(result)
end
```

例3
```ruby
def run
  data, csv_body = fetch_data
  result = calculate(data, csv_body)
  save(result)
end

def fetch_data
  csv_body = read_csv
  fetch_from_db, csv_body
end

def save(result)
  save_to_db(result)
  output_to_csv(result)
end
```

















